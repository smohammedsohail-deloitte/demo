# Terraform Azure API Management

Azure API Management is a service offered by Microsoft Azure that allows organizations to create, publish, manage, and secure APIs (Application Programming Interfaces).The service provides a range of features that enable organizations to expose their APIs to external developers, partners, and customers in a secure and scalable manner. It provides a centralized platform to manage APIs, including authentication, rate limiting, caching, monitoring, and analytics.

Azure API Management can be used to create APIs using a variety of protocols, including REST, SOAP, and OData. It supports a range of authentication mechanisms, including OAuth, OpenID Connect, and JSON Web Tokens (JWTs).
The service also includes a developer portal that allows developers to discover and learn about the APIs available to them, as well as to test and debug their applications.

## Supported Features

- Certificate Configuration
- Network Rules
- Gateway Configuration
- SCM Configuration
- Proxy Configuration
- Portal Configuration
- Management of Users, Groups and Products
- Policy Configuration
- Named Values

## Usage

```hcl
module "apim" {
  source  = "../modules"

  location       = module.azure_region.location
  location_short = module.azure_region.location_short
  client_name    = var.client_name
  environment    = var.environment
  stack          = var.stack

  resource_group_name = module.rg.resource_group_name

  sku_name        = "Standard_1"
  publisher_name  = "Contoso ApiManager"
  publisher_email = "api_manager@test.com"

  named_values = [
    {
      name   = "my_named_value"
      value  = "my_secret_value"
      secret = true
    },
    {
      display_name = "My second value explained"
      name         = "my_second_value"
      value        = "my_not_secret_value"
    }
  ]

  additional_location = [
    {
      location  = "eastus2"
      subnet_id = var.subnet_id
    },
  ]
}
```

## Requirements

| Name      | Version   |
| --------- | --------- |
| terraform | >= 0.13   |
| azurerm   | >= 2.59.0 |

## Providers

| Name    | Version   |
| ------- | --------- |
| azurerm | >= 2.59.0 |

## Resources

| Name                                                                                                                                                               | Type     |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------- |
| [azurerm_api_management.apim](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/api_management)                                      | resource |
| [azurerm_api_management_group.group](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/api_management_group)                         | resource |
| [azurerm_api_management_named_value.named_values](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/api_management_named_value)      | resource |
| [azurerm_api_management_product.product](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/api_management_product)                   | resource |
| [azurerm_api_management_product_group.product_group](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/api_management_product_group) | resource |
| [azurerm_network_security_rule.management_apim](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_rule)             | resource |

## Inputs

| Name                                    | Description                                                                                                                                                                                                                                                                                                                                                                                                                                | Type                | Default                                                                                           | Required |
| --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------- | ------------------------------------------------------------------------------------------------- | :------: | --- |
| additional_location                     | List of the name of the Azure Region in which the API Management Service should be expanded to.                                                                                                                                                                                                                                                                                                                                            | `list(map(string))` | `[]`                                                                                              |    no    |
| certificate_configuration               | List of certificate configurations                                                                                                                                                                                                                                                                                                                                                                                                         | `list(map(string))` | `[]`                                                                                              |    no    |
| client_certificate_enabled              | (Optional) Enforce a client certificate to be presented on each request to the gateway? This is only supported when SKU type is `Consumption`.                                                                                                                                                                                                                                                                                             | `bool`              | `false`                                                                                           |    no    |
| client_name                             | Client name/account used in naming                                                                                                                                                                                                                                                                                                                                                                                                         | `string`            | n/a                                                                                               |   yes    |
| create_management_rule                  | Whether to create the NSG rule for the management port of the APIM. If true, nsg_name variable must be set                                                                                                                                                                                                                                                                                                                                 | `bool`              | `false`                                                                                           |    no    |
| create_product_group_and_relationships  | Create local APIM groups with name identical to products and create a relationship between groups and products                                                                                                                                                                                                                                                                                                                             | `bool`              | `false`                                                                                           |    no    |
| custom_diagnostic_settings_name         | Custom name of the diagnostics settings, name will be 'default' if not set.                                                                                                                                                                                                                                                                                                                                                                | `string`            | `"default"`                                                                                       |    no    |
| custom_management_rule_name             | Custom NSG rule name for APIM Management.                                                                                                                                                                                                                                                                                                                                                                                                  | `string`            | `""`                                                                                              |    no    |
| custom_name                             | Custom API Management name, generated if not set.                                                                                                                                                                                                                                                                                                                                                                                          | `string`            | `""`                                                                                              |    no    |
| default_tags_enabled                    | Option to enable or disable default tags                                                                                                                                                                                                                                                                                                                                                                                                   | `bool`              | `true`                                                                                            |    no    |
| developer_portal_hostname_configuration | Developer portal hostname configurations                                                                                                                                                                                                                                                                                                                                                                                                   | `list(map(string))` | `[]`                                                                                              |    no    |
| enable_http2                            | Should HTTP/2 be supported by the API Management Service?                                                                                                                                                                                                                                                                                                                                                                                  | `bool`              | `false`                                                                                           |    no    |
| enable_sign_in                          | Should anonymous users be redirected to the sign in page?                                                                                                                                                                                                                                                                                                                                                                                  | `bool`              | `false`                                                                                           |    no    |
| enable_sign_up                          | Can users sign up on the development portal?                                                                                                                                                                                                                                                                                                                                                                                               | `bool`              | `false`                                                                                           |    no    |
| environment                             | Project environment                                                                                                                                                                                                                                                                                                                                                                                                                        | `string`            | n/a                                                                                               |   yes    |
| extra_tags                              | Extra tags to add                                                                                                                                                                                                                                                                                                                                                                                                                          | `map(string)`       | `{}`                                                                                              |    no    |
| gateway_disabled                        | (Optional) Disable the gateway in main region? This is only supported when `additional_location` is set.                                                                                                                                                                                                                                                                                                                                   | `bool`              | `false`                                                                                           |    no    |
| identity_ids                            | A list of IDs for User Assigned Managed Identity resources to be assigned. This is required when type is set to UserAssigned or SystemAssigned, UserAssigned.                                                                                                                                                                                                                                                                              | `list(string)`      | `[]`                                                                                              |    no    |
| identity_type                           | Type of Managed Service Identity that should be configured on this API Management Service                                                                                                                                                                                                                                                                                                                                                  | `string`            | `"SystemAssigned"`                                                                                |    no    |
| location                                | Azure location for Eventhub.                                                                                                                                                                                                                                                                                                                                                                                                               | `string`            | n/a                                                                                               |   yes    |
| location_short                          | Short string for Azure location.                                                                                                                                                                                                                                                                                                                                                                                                           | `string`            | n/a                                                                                               |   yes    |
| logs_categories                         | Log categories to send to destinations.                                                                                                                                                                                                                                                                                                                                                                                                    | `list(string)`      | `null`                                                                                            |    no    |
| logs_destinations_ids                   | List of destination resources IDs for logs diagnostic destination.<br>Can be `Storage Account`, `Log Analytics Workspace` and `Event Hub`. No more than one of each can be set.<br>If you want to specify an Azure EventHub to send logs and metrics to, you need to provide a formated string with both the EventHub Namespace authorization send ID and the EventHub name (name of the queue to use in the Namespace) separated by the ` | ` character.        | `list(string)`                                                                                    |   n/a    | yes |
| logs_metrics_categories                 | Metrics categories to send to destinations.                                                                                                                                                                                                                                                                                                                                                                                                | `list(string)`      | `null`                                                                                            |    no    |
| logs_retention_days                     | Number of days to keep logs on storage account.                                                                                                                                                                                                                                                                                                                                                                                            | `number`            | `30`                                                                                              |    no    |
| management_hostname_configuration       | List of management hostname configurations                                                                                                                                                                                                                                                                                                                                                                                                 | `list(map(string))` | `[]`                                                                                              |    no    |
| management_nsg_rule_priority            | Priority of the NSG rule created for the management port of the APIM                                                                                                                                                                                                                                                                                                                                                                       | `number`            | `101`                                                                                             |    no    |
| min_api_version                         | (Optional) The version which the control plane API calls to API Management service are limited with version equal to or newer than.                                                                                                                                                                                                                                                                                                        | `string`            | `null`                                                                                            |    no    |
| name_prefix                             | Optional prefix for the generated name                                                                                                                                                                                                                                                                                                                                                                                                     | `string`            | `""`                                                                                              |    no    |
| name_suffix                             | Optional suffix for the generated name                                                                                                                                                                                                                                                                                                                                                                                                     | `string`            | `""`                                                                                              |    no    |
| named_values                            | Map containing the name of the named values as key and value as values                                                                                                                                                                                                                                                                                                                                                                     | `list(map(string))` | `[]`                                                                                              |    no    |
| notification_sender_email               | Email address from which the notification will be sent                                                                                                                                                                                                                                                                                                                                                                                     | `string`            | `null`                                                                                            |    no    |
| nsg_name                                | NSG name of the subnet hosting the APIM to add the rule to allow management if the APIM is private                                                                                                                                                                                                                                                                                                                                         | `string`            | `null`                                                                                            |    no    |
| nsg_rg_name                             | Name of the RG hosting the NSG if it's different from the one hosting the APIM                                                                                                                                                                                                                                                                                                                                                             | `string`            | `null`                                                                                            |    no    |
| policy_configuration                    | Map of policy configuration                                                                                                                                                                                                                                                                                                                                                                                                                | `map(string)`       | `{}`                                                                                              |    no    |
| portal_hostname_configuration           | Legacy portal hostname configurations                                                                                                                                                                                                                                                                                                                                                                                                      | `list(map(string))` | `[]`                                                                                              |    no    |
| products                                | List of products to create                                                                                                                                                                                                                                                                                                                                                                                                                 | `list(string)`      | `[]`                                                                                              |    no    |
| proxy_hostname_configuration            | List of proxy hostname configurations                                                                                                                                                                                                                                                                                                                                                                                                      | `list(map(string))` | `[]`                                                                                              |    no    |
| publisher_email                         | The email of publisher/company.                                                                                                                                                                                                                                                                                                                                                                                                            | `string`            | n/a                                                                                               |   yes    |
| publisher_name                          | The name of publisher/company.                                                                                                                                                                                                                                                                                                                                                                                                             | `string`            | n/a                                                                                               |   yes    |
| resource_group_name                     | Name of the resource group                                                                                                                                                                                                                                                                                                                                                                                                                 | `string`            | n/a                                                                                               |   yes    |
| scm_hostname_configuration              | List of scm hostname configurations                                                                                                                                                                                                                                                                                                                                                                                                        | `list(map(string))` | `[]`                                                                                              |    no    |
| security_configuration                  | Map of security configuration                                                                                                                                                                                                                                                                                                                                                                                                              | `map(string)`       | `{}`                                                                                              |    no    |
| sku_name                                | String consisting of two parts separated by an underscore. The fist part is the name, valid values include: Developer, Basic, Standard and Premium. The second part is the capacity                                                                                                                                                                                                                                                        | `string`            | `"Basic_1"`                                                                                       |    no    |
| stack                                   | Project stack name                                                                                                                                                                                                                                                                                                                                                                                                                         | `string`            | n/a                                                                                               |   yes    |
| terms_of_service_configuration          | Map of terms of service configuration                                                                                                                                                                                                                                                                                                                                                                                                      | `list(map(string))` | <pre>[<br> {<br> "consent_required": false,<br> "enabled": false,<br> "text": ""<br> }<br>]</pre> |    no    |
| use_caf_naming                          | Use the Azure CAF naming provider to generate default resource name. `custom_name` override this if set. Legacy default name is used if this is set to `false`.                                                                                                                                                                                                                                                                            | `bool`              | `true`                                                                                            |    no    |
| virtual_network_configuration           | The id(s) of the subnet(s) that will be used for the API Management. Required when virtual_network_type is External or Internal                                                                                                                                                                                                                                                                                                            | `list(string)`      | `[]`                                                                                              |    no    |
| virtual_network_type                    | The type of virtual network you want to use, valid values include: None, External, Internal.                                                                                                                                                                                                                                                                                                                                               | `string`            | `null`                                                                                            |    no    |
| zones                                   | (Optional) Specifies a list of Availability Zones in which this API Management service should be located. Changing this forces a new API Management service to be created. Supported in Premium Tier.                                                                                                                                                                                                                                      | `list(number)`      | <pre>[<br> 1,<br> 2,<br> 3<br>]</pre>                                                             |    no    |

## Outputs

| Name                                | Description                                                                  |
| ----------------------------------- | ---------------------------------------------------------------------------- |
| api_management_additional_location  | Map listing gateway_regional_url and public_ip_addresses associated          |
| api_management_gateway_regional_url | The Region URL for the Gateway of the API Management Service                 |
| api_management_gateway_url          | The URL of the Gateway for the API Management Service                        |
| api_management_id                   | The ID of the API Management Service                                         |
| api_management_identity             | The identity of the API Management                                           |
| api_management_management_api_url   | The URL for the Management API associated with this API Management service   |
| api_management_name                 | The name of the API Management Service                                       |
| api_management_portal_url           | The URL for the Publisher Portal associated with this API Management service |
| api_management_private_ip_addresses | The Private IP addresses of the API Management Service                       |
| api_management_public_ip_addresses  | The Public IP addresses of the API Management Service                        |
| api_management_scm_url              | The URL for the SCM Endpoint associated with this API Management service     |
